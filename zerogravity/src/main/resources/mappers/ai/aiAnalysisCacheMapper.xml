<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zerogravity.myapp.ai.dao.AIAnalysisCacheDao">

	<!-- Result map for AIAnalysisCache -->
	<resultMap id="aiAnalysisCacheResultMap" type="AIAnalysisCache">
		<id property="cacheId" column="cache_id" />
		<result property="userId" column="user_id" />
		<result property="period" column="period" />
		<result property="startDate" column="start_date" />
		<result property="endDate" column="end_date" />
		<result property="summaryJson" column="summary_json" />
		<result property="generatedAt" column="generated_at" />
		<result property="expiresAt" column="expires_at" />
	</resultMap>

	<!-- Select valid cache entry (not expired) -->
	<select id="selectValidCache" resultMap="aiAnalysisCacheResultMap">
		SELECT cache_id, user_id, period, start_date, end_date,
		       summary_json, generated_at, expires_at
		FROM ai_analysis_cache
		WHERE user_id = #{userId}
		  AND period = #{period}
		  AND start_date = #{startDate}
		  AND expires_at > NOW()
		LIMIT 1
	</select>

	<!-- Insert cache entry -->
	<insert id="insertCache">
		INSERT INTO ai_analysis_cache (
			cache_id, user_id, period, start_date, end_date,
			summary_json, generated_at, expires_at
		) VALUES (
			#{cacheId}, #{userId}, #{period}, #{startDate}, #{endDate},
			#{summaryJson}, #{generatedAt}, #{expiresAt}
		)
	</insert>

	<!-- Delete cache by user ID and date range -->
	<delete id="deleteCacheByUserIdAndDateRange">
		DELETE FROM ai_analysis_cache
		WHERE user_id = #{userId}
		  AND start_date &lt;= #{endDate}
		  AND end_date &gt;= #{startDate}
	</delete>

	<!-- Delete expired cache entries -->
	<delete id="deleteExpiredCache">
		DELETE FROM ai_analysis_cache
		WHERE expires_at &lt;= NOW()
	</delete>

</mapper>
