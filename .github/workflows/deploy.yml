name: Deploy Backend

on:
  push:
    branches:
      - develop
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ENV=prod" >> $GITHUB_ENV
            echo "BACKEND_PORT=8080" >> $GITHUB_ENV
            echo "MYSQL_PORT=3306" >> $GITHUB_ENV
            echo "DB_NAME=zerogravity_prod" >> $GITHUB_ENV
            echo "DEPLOY_TARGET=Production (api.zerogv.com)" >> $GITHUB_ENV
          else
            echo "ENV=dev" >> $GITHUB_ENV
            echo "BACKEND_PORT=8081" >> $GITHUB_ENV
            echo "MYSQL_PORT=3307" >> $GITHUB_ENV
            echo "DB_NAME=zerogravity_dev" >> $GITHUB_ENV
            echo "DEPLOY_TARGET=Development (api-dev.zerogv.com)" >> $GITHUB_ENV
          fi

      - name: Deploy to OCI server
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV: ${{ env.ENV }}
          BACKEND_PORT: ${{ env.BACKEND_PORT }}
          MYSQL_PORT: ${{ env.MYSQL_PORT }}
          DB_NAME: ${{ env.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENV,BACKEND_PORT,MYSQL_PORT,DB_NAME,DB_USER,DB_PASSWORD,JWT_SECRET,GEMINI_API_KEY,MYSQL_ROOT_PASSWORD
          script: |
            # Navigate to app directory
            cd /home/ubuntu/app

            # Pull latest code
            git fetch origin
            if [ "$ENV" = "prod" ]; then
              git checkout main
              git pull origin main
            else
              git checkout develop
              git pull origin develop
            fi

            # Create .env file
            cat > .env << EOF
            ENV=$ENV
            BACKEND_PORT=$BACKEND_PORT
            MYSQL_PORT=$MYSQL_PORT
            DB_NAME=$DB_NAME
            DB_USER=$DB_USER
            DB_PASSWORD=$DB_PASSWORD
            JWT_SECRET=$JWT_SECRET
            GEMINI_API_KEY=$GEMINI_API_KEY
            MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
            EOF

            # Stop only current environment containers (not all environments)
            docker compose -p zerogv-${ENV} down || true

            # Build and start current environment containers
            docker compose -p zerogv-${ENV} up -d --build

            # Wait for backend to be healthy
            echo "Waiting for backend to be healthy..."
            for i in {1..30}; do
              if docker inspect zerogv-backend-$ENV | grep -q '"Health".*"healthy"'; then
                echo "Backend is healthy!"
                break
              fi
              echo "Attempt $i/30: Backend not yet healthy, waiting..."
              sleep 5
            done

            # Deploy Nginx configuration
            ./scripts/deploy-nginx.sh

            # Show container status
            docker ps | grep zerogv

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV: ${{ env.ENV }}
          BACKEND_PORT: ${{ env.BACKEND_PORT }}
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENV,BACKEND_PORT
          script: |
            # Check health endpoint
            echo "Checking health endpoint..."
            curl -f http://localhost:$BACKEND_PORT/actuator/health || exit 1
            echo "Health check passed!"

      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "Environment: ${{ env.ENV }}"
          echo "Target: ${{ env.DEPLOY_TARGET }}"
          echo "Backend Port: ${{ env.BACKEND_PORT }}"
          echo "MySQL Port: ${{ env.MYSQL_PORT }}"
